# language setting
language: node_js

# version numbers, testing against two versions of node
node_js:
  - 0.10.33

env:
  global:
    - XUNIT_FILE=./shippable/testresults/result.xml
    - APPLICATION=shippable
    - SERVICE=micro-api
    - REGISTRY_ACCOUNT=195324580561.dkr.ecr.us-west-2.amazonaws.com # image registry account name/location

build:
  pre_ci:
    - docker build -t $REGISTRY_ACCOUNT/$APPLICATION/$SERVICE:latest .
    - node --version
    - mkdir -p ./shippable/testresults
    - mkdir -p ./shippable/codecoverage
  pre_ci_boot:
    image_name: $REGISTRY_ACCOUNT/$APPLICATION/$SERVICE
    image_tag: latest
    pull: false
    options: --privileged=true
  ci:
    - npm install
    - grunt
  post_ci:
    - ./node_modules/.bin/istanbul cover grunt -- -u tdd
    - ./node_modules/.bin/istanbul report cobertura --dir  ./shippable/codecoverage/
    - echo $BUILD_NUMBER > ~/buildConfig.txt
    - docker tag -f $REGISTRY_ACCOUNT/$APPLICATION/$SERVICE:latest $REGISTRY_ACCOUNT/$APPLICATION/$SERVICE:$BRANCH.$BUILD_NUMBER
    - docker push $REGISTRY_ACCOUNT/$APPLICATION/$SERVICE:$BRANCH.$BUILD_NUMBER

integrations:
    hub:
      - integrationName: "labmvdev"
        type: ecr
        region: us-west-2
        agent_only: false
        branches:
          only:
            - amazon-ecr-ecs-beta
    notifications:
      - integrationName: slack_notifications
        type: slack
        recipients:
          - "#beta"
        branches:
          only:
            - amazon-ecr-ecs-beta
        on_start : never
        on_success: always
        on_failure: always
      - integrationName: email
        type: email
        branches:
          only:
            - amazon-ecr-ecs-beta
        on_success: never
        on_failure: never
        on_pull_request: never
